<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas G-Code Sender</title>
    <style>
        canvas {
            border: 1px solid black;
            cursor: crosshair;
        }
    </style>
</head>
<body>

<h1>Draw on the Canvas</h1>
<canvas id="drawingCanvas" width="500" height="400"></canvas>
<br>
<button id="sendGCode">Send G-Code</button>

<script>
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    // Start drawing
    canvas.addEventListener('mousedown', (e) => {
        drawing = true;
        ctx.moveTo(e.offsetX, e.offsetY);
    });

    // Draw on the canvas
    canvas.addEventListener('mousemove', (e) => {
        if (drawing) {
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        }
    });

    // Stop drawing
    canvas.addEventListener('mouseup', () => {
        drawing = false;
        ctx.beginPath();
    });

    // Convert canvas to G-code
    function generateGCode() {
        // Simple G-code generation based on drawn paths
        const gcode = [];
        gcode.push('G21 ; Set units to mm');
        gcode.push('G90 ; Absolute positioning');
        gcode.push('M5 ; Stop any spindle movement');
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        for (let y = 0; y < canvas.height; y++) {
            for (let x = 0; x < canvas.width; x++) {
                const index = (y * canvas.width + x) * 4;
                const alpha = data[index + 3];

                if (alpha > 0) {
                    gcode.push(`G1 X${x} Y${y} ; Draw line`);
                }
            }
        }
        gcode.push('M30 ; End of program');

        return gcode.join('\n');
    }

    // Send G-code to API
    document.getElementById('sendGCode').addEventListener('click', () => {
        const gcode = generateGCode();
        fetch('192.168.1.157/plot', {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain',
            },
            body: gcode,
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    });
</script>

</body>
</html>